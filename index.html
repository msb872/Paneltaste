<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ØªØ³Øª Ù¾Ù†Ù„</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      margin: 20px auto;
      max-width: 1200px;
      direction: rtl;
      text-align: right;
      color: #333;
    }

    /* ÙØ±Ù… Ø§ØµÙ„ÛŒ */
    form {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 6px;
      background: #fafafa;
    }
    fieldset {
      border: 1px solid #bbb;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }
    legend { font-weight: bold; }
    label { margin-left: .5rem; cursor: pointer; }

    .product-code-options {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .product-code-options input[type="text"] {
      width: 120px;
      padding: .4rem;
      border: 1px solid #bbb;
      border-radius: 4px;
    }

    .param-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .param-box {
      flex: 1 1 200px;
      border: 1px solid #ddd;
      padding: .8rem;
      border-radius: 4px;
      background: #fff;
    }
    .param-box .options {
      display: flex;
      flex-wrap: wrap;
      gap: .8rem;
      margin-top: .5rem;
    }

    .buttons, .export-btns {
      margin-top: 1rem;
    }
    .buttons button,
    .export-btns button {
      margin-left: .5rem;
      padding: .6rem 1.2rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    .buttons button { background: #1976d2; }
    .buttons button:hover { background: #0f5caa; }
    .export-btns button.csv    { background: #388e3c; }
    .export-btns button.excel  { background: #1e88e5; }
    .export-btns button.delete { background: #d32f2f; }

    #tableProductName {
      font-weight: bold;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: .6rem;
      text-align: center;
    }
    .action-btn {
      background: #f57c00;
      margin: 0 .2rem;
      padding: .2rem .6rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    .action-btn.delete { background: #d32f2f; }

    /* Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ */
    .charts-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
    }
    .chart-container {
      flex: 1 1 200px;
      height: 200px;
      position: relative;
    }
    .chart-label {
      text-align: center;
      margin-top: .3rem;
      font-size: .95rem;
    }

    /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù†Ø§ÙˆØ± Ø±Ø§Ù‡Ù†Ù…Ø§/Ø¯Ø±Ø¨Ø§Ø±Ù‡ */
    .float-buttons {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      z-index: 1000;
    }
    .float-buttons button {
      padding: .6rem 1rem;
      border: none;
      border-radius: 4px;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }
    .float-buttons button:hover {
      background: #0f5caa;
    }

    /* Ú†Ø§Ù¾: ÙÙ‚Ø· Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ø¯Ùˆ Ø³ØªÙˆÙ†Ù‡ */
    @media print {
      form, .buttons, .export-btns, .float-buttons { display: none !important; }
      /* Ø¬Ø¯ÙˆÙ„ Ùˆ ØªØ­Ù„ÛŒÙ„ ØªÚ© Ø³ØªÙˆÙ†Ù‡ */
      #tableProductName, h3, #analysis, table { page-break-inside: avoid; }
      /* Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ø¯Ùˆ Ø³ØªÙˆÙ†Ù‡ */
      .charts-row {
        display: block;
        column-count: 2;
        column-gap: 1rem;
      }
      .chart-container {
        break-inside: avoid-column;
        page-break-inside: avoid;
        margin-bottom: 1rem;
      }
      .chart-label, canvas {
        display: block !important;
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>

  <h2 id="jalali-date" aria-label="ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ"></h2>

  <form id="evaluation-form" aria-label="ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ØªØ³Øª Ù¾Ù†Ù„">
    <fieldset>
      <legend>Ù…Ø´Ø®ØµØ§Øª ÙØ±Ø¯ÛŒ</legend>
      <div>
        <span>ØªØ­ØµÛŒÙ„Ø§Øª:</span>
        <label><input name="education" type="radio" value="Ø¯ÛŒÙ¾Ù„Ù…" required>Ø¯ÛŒÙ¾Ù„Ù…</label>
        <label><input name="education" type="radio" value="Ú©Ø§Ø±Ø¯Ø§Ù†ÛŒ">Ú©Ø§Ø±Ø¯Ø§Ù†ÛŒ</label>
        <label><input name="education" type="radio" value="Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ">Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ</label>
        <label><input name="education" type="radio" value="Ø§Ø±Ø´Ø¯">Ø§Ø±Ø´Ø¯</label>
        <label><input name="education" type="radio" value="Ø¯Ú©ØªØ±Ø§">Ø¯Ú©ØªØ±Ø§</label>
      </div>
      <div style="margin-top:1rem;">
        <span>Ø¬Ù†Ø³ÛŒØª:</span>
        <label><input name="gender" type="radio" value="Ø¢Ù‚Ø§" required>Ø¢Ù‚Ø§</label>
        <label><input name="gender" type="radio" value="Ø®Ø§Ù†Ù…">Ø®Ø§Ù†Ù…</label>
      </div>
      <div class="product-code-options">
        <span>Ú©Ø¯ Ù…Ø­ØµÙˆÙ„:</span>
        <label><input name="productCode" type="radio" value="A" required>A</label>
        <label><input name="productCode" type="radio" value="B">B</label>
        <label><input name="productCode" type="radio" value="C">C</label>
        <label><input name="productCode" type="radio" value="D">D</label>
        <label><input name="productCode" type="radio" value="E">E</label>
        <label><input name="productCode" type="radio" value="F">F</label>
        <label><input name="productCode" type="radio" value="G">G</label>
        <label><input name="productCode" type="radio" value="manual">Ø³Ø§ÛŒØ±</label>
        <input id="manualProductCode" name="manualProductCode"
               type="text" placeholder="ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ø¯ Ù…Ø­ØµÙˆÙ„" disabled>
      </div>
      <div style="margin-top:1rem;">
        <label for="productName">Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„:</label>
        <input id="productName" name="productName" type="text"
               placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§</legend>
      <div class="param-row">
        <div class="param-box">
          <label>Ø±Ù†Ú¯:</label>
          <div class="options">
            <label><input name="color" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="color" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="color" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="color" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="color" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
          </div>
        </div>
        <div class="param-box">
          <label>Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡:</label>
          <div class="options">
            <label><input name="taste" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="taste" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="taste" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="taste" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="taste" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
          </div>
        </div>
      </div>
      <div class="param-row">
        <div class="param-box">
          <label>Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ:</label>
          <div class="options">
            <label><input name="smell" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="smell" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="smell" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="smell" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="smell" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
          </div>
        </div>
        <div class="param-box">
          <label>Ø¨Ø§ÙØª:</label>
          <div class="options">
            <label><input name="texture" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="texture" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="texture" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="texture" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="texture" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
          </div>
        </div>
      </div>
      <div class="param-row">
        <div class="param-box">
          <label>Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ:</label>
          <div class="options">
            <label><input name="mouthfeel" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="mouthfeel" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="mouthfeel" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="mouthfeel" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="mouthfeel" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
          </div>
        </div>
      </div>
      <div class="buttons">
        <button type="submit">Ø«Ø¨Øª</button>
        <button id="resetBtn" type="button">Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„</button>
        <button type="button" onclick="window.print()">Ú†Ø§Ù¾</button>
      </div>
    </fieldset>
  </form>

  <div id="tableProductName"></div>

  <h3>Ø¬Ø¯ÙˆÙ„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</h3>
  <table id="data-table">
    <thead>
      <tr>
        <th>Ú©Ø¯ Ù…Ø­ØµÙˆÙ„</th><th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th><th>ØªØ­ØµÛŒÙ„Ø§Øª</th>
        <th>Ø¬Ù†Ø³ÛŒØª</th><th>Ø±Ù†Ú¯</th><th>Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡</th>
        <th>Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ</th><th>Ø¨Ø§ÙØª</th><th>Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="export-btns">
    <button class="csv" onclick="exportCSV()">Export CSV</button>
    <button class="excel" onclick="exportExcel()">Export Excel</button>
    <button class="delete" onclick="clearAll()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
  </div>

  <h3>ØªØ­Ù„ÛŒÙ„ Ù…Ù‚Ø§ÛŒØ³Ù‡â€ŒØ§ÛŒ</h3>
  <div id="analysis"></div>

  <h3>Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</h3>
  <div class="charts-row">
    <div class="chart-container">
      <canvas id="colorChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±Ù†Ú¯</p>
    </div>
    <div class="chart-container">
      <canvas id="tasteChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡</p>
    </div>
    <div class="chart-container">
      <canvas id="smellChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ</p>
    </div>
    <div class="chart-container">
      <canvas id="textureChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¨Ø§ÙØª</p>
    </div>
    <div class="chart-container">
      <canvas id="mouthfeelChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ</p>
    </div>
  </div>

  <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ Ùˆ Ø´Ù†Ø§ÙˆØ± -->
  <div class="float-buttons">
    <button id="helpBtn" type="button">ğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§</button>
    <button id="contactBtn" type="button">â„¹ï¸ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</button>
  </div>

  <script>
    Chart.register(ChartDataLabels);

    let evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
    let editingIndex = -1;

    document.addEventListener('DOMContentLoaded', () => {
      setJalaliDate();
      bindManualToggle();
      loadTable();
      updateAnalysisAndCharts();

      document.getElementById('resetBtn').addEventListener('click', () => {
        resetForm(); window.scrollTo(0,0);
      });

      document.getElementById('helpBtn').addEventListener('click', () => {
        alert(`Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ:
1. Ù…Ø´Ø®ØµØ§Øª ÙØ±Ø¯ÛŒ: ØªØ­ØµÛŒÙ„Ø§ØªØŒ Ø¬Ù†Ø³ÛŒØªØŒ Ú©Ø¯ Ù…Ø­ØµÙˆÙ„ (Aâ€“G ÛŒØ§ Ø³Ø§ÛŒØ±) Ùˆ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„.
2. Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ: Ø±Ù†Ú¯ØŒ Ø·Ø¹Ù…ØŒ Ø¹Ø·Ø±ØŒ Ø¨Ø§ÙØª Ùˆ Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ (Ù‡Ø±Ú©Ø¯Ø§Ù… 1â€“5).
3. Ø«Ø¨Øª: Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ.
4. Ø±ÛŒØ³Øª: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù….
5. Ú†Ø§Ù¾: Ù†Ø³Ø®Ù‡ Ú†Ø§Ù¾ÛŒ Ø¨Ø§ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ø¯Ùˆ Ø³ØªÙˆÙ†Ù‡.`);
      });

      document.getElementById('contactBtn').addEventListener('click', () => {
        alert(`Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡:
Ù†Ø§Ù…: Mosayeb  
ØªØ®ØµØµ: ØªÙˆØ³Ø¹Ù‡ ÙˆØ¨ Ùˆ ØªØ­Ù„ÛŒÙ„ Ø¯Ø§Ø¯Ù‡  
Ø§ÛŒÙ…ÛŒÙ„: mosayeb872@gmail.com  
ğŸ“¬ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ØŒ Ø³ÙˆØ®Øª Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ Ù‡Ø³ØªÙ†Ø¯!`);
      });

      document.getElementById('evaluation-form').addEventListener('submit', e => {
        e.preventDefault();
        const f = e.target;
        const code = f.productCode.value === 'manual'
                     ? f.manualProductCode.value.trim()
                     : f.productCode.value;
        const data = {
          productCode: code,
          productName: f.productName.value,
          education: f.education.value,
          gender: f.gender.value,
          color: +f.color.value,
          taste: +f.taste.value,
          smell: +f.smell.value,
          texture: +f.texture.value,
          mouthfeel: +f.mouthfeel.value
        };
        if (editingIndex > -1) evaluations[editingIndex] = data;
        else evaluations.push(data);

        localStorage.setItem('evaluations', JSON.stringify(evaluations));
        localStorage.setItem('currentProductName', data.productName);
        resetForm();
        loadTable();
        updateAnalysisAndCharts();
      });
    });

    function bindManualToggle() {
      document.querySelectorAll('input[name="productCode"]').forEach(radio => {
        radio.addEventListener('change', e => {
          const manual = document.getElementById('manualProductCode');
          if (e.target.value === 'manual') {
            manual.disabled = false;
            manual.required = true;
            manual.focus();
          } else {
            manual.disabled = true;
            manual.required = false;
            manual.value = '';
          }
        });
      });
    }

    function setJalaliDate() {
      const j = jalaali.toJalaali(new Date());
      document.getElementById('jalali-date').innerText =
        `ØªØ§Ø±ÛŒØ®: ${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
    }

    function resetForm() {
      document.getElementById('evaluation-form').reset();
      editingIndex = -1;
      const manual = document.getElementById('manualProductCode');
      manual.disabled = true;
      manual.required = false;
      manual.value = '';
    }

    function loadTable() {
      const nameDiv = document.getElementById('tableProductName');
      const prod = localStorage.getItem('currentProductName') || '';
      nameDiv.innerText = prod ? `Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„: ${prod}` : '';

      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      evaluations.forEach((d,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.productCode}</td>
          <td>${d.productName}</td>
          <td>${d.education}</td>
          <td>${d.gender}</td>
          <td>${d.color}</td>
          <td>${d.taste}</td>
          <td>${d.smell}</td>
          <td>${d.texture}</td>
          <td>${d.mouthfeel}</td>
          <td>
            <button class="action-btn" onclick="editRow(${i})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button class="action-btn delete" onclick="deleteRow(${i})">Ø­Ø°Ù</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function editRow(i) {
      const d = evaluations[i];
      const f = document.getElementById('evaluation-form');
      const manual = document.getElementById('manualProductCode');
      if (!['A','B','C','D','E','F','G'].includes(d.productCode)) {
        f.productCode.value = 'manual';
        manual.disabled = false;
        manual.required = true;
        manual.value = d.productCode;
      } else {
        f.productCode.value = d.productCode;
        manual.disabled = true;
        manual.required = false;
        manual.value = '';
      }
      f.productName.value = d.productName;
      f.education.value   = d.education;
      f.gender.value      = d.gender;
      f.color.value       = d.color;
      f.taste.value       = d.taste;
      f.smell.value       = d.smell;
      f.texture.value     = d.texture;
      f.mouthfeel.value   = d.mouthfeel;
      editingIndex = i;
      window.scrollTo(0,0);
    }

    function deleteRow(i) {
      if (!confirm('Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      evaluations.splice(i,1);
      localStorage.setItem('evaluations', JSON.stringify(evaluations));
      loadTable();
      updateAnalysisAndCharts();
    }

    function clearAll() {
      if (!confirm('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      localStorage.removeItem('evaluations');
      evaluations = [];
      loadTable();
      updateAnalysisAndCharts();
    }

    let charts = {};

    function updateAnalysisAndCharts() {
      const analysisDiv = document.getElementById('analysis');
      if (!evaluations.length) {
        analysisDiv.innerText = 'Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.';
        Object.values(charts).forEach(c => c.clear());
        return;
      }
      const codes = Array.from(new Set(evaluations.map(d => d.productCode)));
      const groups = {};
      codes.forEach(c => groups[c] = []);
      evaluations.forEach(d => groups[d.productCode].push(d));

      const avg = {};
      codes.forEach(code => {
        const arr = groups[code];
        avg[code] = {
          color:     arr.reduce((s,x) => s + x.color,0) / arr.length,
          taste:     arr.reduce((s,x) => s + x.taste,0) / arr.length,
          smell:     arr.reduce((s,x) => s + x.smell,0) / arr.length,
          texture:   arr.reduce((s,x) => s + x.texture,0) / arr.length,
          mouthfeel: arr.reduce((s,x) => s + x.mouthfeel,0) / arr.length
        };
      });

      const rank = prop => [...codes].sort((a,b) => avg[b][prop] - avg[a][prop]);
      const bestColor     = rank('color')[0];
      const bestTaste     = rank('taste')[0];
      const bestSmell     = rank('smell')[0];
      const bestTexture   = rank('texture')[0];
      const bestMouthfeel = rank('mouthfeel')[0];
      const overall = codes.slice().sort((a,b) => {
        const sumA = avg[a].color + avg[a].taste + avg[a].smell + avg[a].texture + avg[a].mouthfeel;
        const sumB = avg[b].color + avg[b].taste + avg[b].smell + avg[b].texture + avg[b].mouthfeel;
        return sumB - sumA;
      })[0];

      analysisDiv.innerText =
`â€¢ Ø¨Ø®Ø´ Ø±Ù†Ú¯: ${bestColor} (${avg[bestColor].color.toFixed(2)})  
â€¢ Ø¨Ø®Ø´ Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡: ${bestTaste} (${avg[bestTaste].taste.toFixed(2)})  
â€¢ Ø¨Ø®Ø´ Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ: ${bestSmell} (${avg[bestSmell].smell.toFixed(2)})  
â€¢ Ø¨Ø®Ø´ Ø¨Ø§ÙØª: ${bestTexture} (${avg[bestTexture].texture.toFixed(2)})  
â€¢ Ø¨Ø®Ø´ Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ: ${bestMouthfeel} (${avg[bestMouthfeel].mouthfeel.toFixed(2)})  
â€¢ Ú©Ù„ÛŒ: Ù†Ù…ÙˆÙ†Ù‡ ${overall} Ø¨Ø±ØªØ± Ø§Ø³Øª.`;

      const dataC = codes.map(c => avg[c].color.toFixed(2));
      const dataT = codes.map(c => avg[c].taste.toFixed(2));
      const dataS = codes.map(c => avg[c].smell.toFixed(2));
      const dataX = codes.map(c => avg[c].texture.toFixed(2));
      const dataM = codes.map(c => avg[c].mouthfeel.toFixed(2));

      const palette = [
        'rgba(255,99,132,0.7)','rgba(54,162,235,0.7)',
        'rgba(255,206,86,0.7)','rgba(75,192,192,0.7)',
        'rgba(153,102,255,0.7)','rgba(255,159,64,0.7)',
        'rgba(99,255,132,0.7)'
      ];
      const colors = {};
      codes.forEach((c,i) => colors[c] = palette[i % palette.length]);

      const makeCfg = (label,data) => ({
        type: 'bar',
        data: { labels: codes, datasets: [{ label, data, backgroundColor: codes.map(c => colors[c]) }] },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { min: 0, max: 5 } },
          plugins: {
            datalabels: { color: '#000', anchor: 'end', align: 'right', formatter: v => v }
          }
        }
      });

      if (!charts.colorChart) {
        charts.colorChart     = new Chart(document.getElementById('colorChart'),     makeCfg('Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±Ù†Ú¯', dataC));
        charts.tasteChart     = new Chart(document.getElementById('tasteChart'),     makeCfg('Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡', dataT));
        charts.smellChart     = new Chart(document.getElementById('smellChart'),     makeCfg('Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ', dataS));
        charts.textureChart   = new Chart(document.getElementById('textureChart'),   makeCfg('Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¨Ø§ÙØª', dataX));
        charts.mouthfeelChart = new Chart(document.getElementById('mouthfeelChart'), makeCfg('Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ', dataM));
      } else {
        [['colorChart',dataC],['tasteChart',dataT],['smellChart',dataS],
         ['textureChart',dataX],['mouthfeelChart',dataM]].forEach(([key,dat]) => {
          charts[key].data.labels = codes;
          charts[key].data.datasets[0].data = dat;
          charts[key].data.datasets[0].backgroundColor = codes.map(c => colors[c]);
          charts[key].update();
        });
      }
    }

    function exportCSV() {
      if (!evaluations.length) { alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.'); return; }
      const header = ['Ú©Ø¯','Ù†Ø§Ù…','ØªØ­ØµÛŒÙ„Ø§Øª','Ø¬Ù†Ø³ÛŒØª','Ø±Ù†Ú¯','Ø·Ø¹Ù…','Ø¹Ø·Ø±','Ø¨Ø§ÙØª','Ø§Ø­Ø³Ø§Ø³'];
      const rows = evaluations.map(d => [
        d.productCode,d.productName,d.education,d.gender,
        d.color,d.taste,d.smell,d.texture,d.mouthfeel
      ]);
      let csv = '\uFEFF' + header.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'evaluations.csv';
      link.click();
    }

    function exportExcel() {
      if (!evaluations.length) { alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.'); return; }
      const header = ['Ú©Ø¯ Ù…Ø­ØµÙˆÙ„','Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„','ØªØ­ØµÛŒÙ„Ø§Øª','Ø¬Ù†Ø³ÛŒØª','Ø±Ù†Ú¯','Ø·Ø¹Ù…','Ø¹Ø·Ø±','Ø¨Ø§ÙØª','Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ'];
      const rows = evaluations.map(d => [
        d.productCode,d.productName,d.education,d.gender,
        d.color,d.taste,d.smell,d.texture,d.mouthfeel
      ]);
      let html = '<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body><table><tr>';
      header.forEach(h => html += `<th>${h}</th>`);
      html += '</tr>';
      rows.forEach(r => {
        html += '<tr>';
        r.forEach(cell => html += `<td>${cell}</td>`);
        html += '</tr>';
      });
      html += '</table></body></html>';
      const blob = new Blob(['\uFEFF', html], { type: 'application/vnd.ms-excel' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'evaluations.xls';
      link.click();
    }
  </script>
</body>
</html>
```
