<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="Taste.png">
  <title>ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ØªØ³Øª Ù¾Ù†Ù„</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
  <style>
    /* Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ¶Ø§ÛŒ ØµÙØ­Ù‡ */
    * { box-sizing: border-box; }

    body {
      margin: 20px auto;
      max-width: 1400px;
      font-family: Tahoma, sans-serif;
      direction: rtl;
      text-align: right;
      color: #333;
      /*background: linear-gradient(135deg, #e0f7fa 0%, #ffe0b2 100%);*/
    }

    form {
      padding: 0.8rem;
      background: rgba(255,255,255,0.9);
      border-radius: 6px;
    }
    fieldset {
      margin-bottom: 0.8rem;
      padding: 0.8rem;
      border: 1px solid #bbb;
      border-radius: 4px;
      background: #fff;
    }
    legend { font-weight: bold; }

    /* Ú†ÛŒØ¯Ù…Ø§Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø¨Ø§ CSS Grid */
    .param-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.6rem;
      margin-bottom: 0.6rem;
    }
    .param-box {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }

    /* Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ø¯ÛŒÙˆÛŒÛŒ Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† */
    .param-box .options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.3rem;
      direction: rtl;
    }
    .param-box .options label {
      display: inline-flex;
      flex-direction: row-reverse;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }

    /* ğŸ‘‡ ØªØºÛŒÛŒØ±: Ú©Ø¯ Ù…Ø­ØµÙˆÙ„ Ø§Ø² Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª */
    .product-code-options {
      direction: ltr;
      text-align: left;
    }
    #manualProductCode {
      direction: ltr;
      text-align: left;
    }

    /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
    .buttons, .export-btns { margin-top: 0.6rem; }
    .buttons button, .export-btns button {
      padding: 0.4rem 0.8rem;
      margin-left: 0.3rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .buttons button { background: #1976d2; }
    .buttons button:hover { background: #0f5caa; }
    .export-btns button.csv    { background: #388e3c; }
    .export-btns button.excel  { background: #1e88e5; }
    .export-btns button.delete { background: #d32f2f; }
    .export-btns button.html   { background: #6a1b9a; }
    .export-btns button.html:hover { background: #4a148c; }

    /* Ø¬Ø¯ÙˆÙ„ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.8rem;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.4rem;
      text-align: center;
    }

    /* Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ø¨Ø§ grid */
    .charts-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.6rem;
      margin-top: 0.8rem;
    }
    .chart-container { height: 150px; }

    /* Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø·Ù„ÙˆØ¨ */
    .best-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.8rem;
      direction: rtl;
      align-items: center;
    }
    .best-selection label {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }
    .best-selection button {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 4px;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .best-selection button:hover { background: #0f5caa; }

    /* Ø¨Ø§Ú©Ø³ Ù†ØªÛŒØ¬Ù‡ */
    .result-box {
      padding: 0.8rem;
      margin-top: 0.8rem;
      border: 2px solid #4caf50;
      background: #e8f5e9;
      border-radius: 6px;
      color: #2e7d32;
      font-weight: bold;
    }

    /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù†Ø§ÙˆØ± */
    .float-buttons {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 1000;
    }
    .float-buttons button {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 4px;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 0.9rem;
    }
    .float-buttons button:hover { background: #0f5caa; }

    /* Ø­Ø§Ù„Øª Ú†Ø§Ù¾ */
    @media print {
      form, .buttons, .export-btns, .float-buttons { display: none !important; }
      .charts-row { column-count: 2; column-gap: 0.8rem; }
    }
  </style>
</head>
<body>

  <h2 id="jalali-date" aria-label="ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ"></h2>

  <form id="evaluation-form" aria-label="ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ùˆ ØªØ³Øª Ù¾Ù†Ù„">
    <fieldset>
      <legend>Ù…Ø´Ø®ØµØ§Øª ÙØ±Ø¯ÛŒ</legend>
      <div>
        <span>ØªØ­ØµÛŒÙ„Ø§Øª:</span>
        <label><input name="education" type="radio" value="Ø¯ÛŒÙ¾Ù„Ù…" required>Ø¯ÛŒÙ¾Ù„Ù…</label>
        <label><input name="education" type="radio" value="Ú©Ø§Ø±Ø¯Ø§Ù†ÛŒ">Ú©Ø§Ø±Ø¯Ø§Ù†ÛŒ</label>
        <label><input name="education" type="radio" value="Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ">Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ</label>
        <label><input name="education" type="radio" value="Ø§Ø±Ø´Ø¯">Ø§Ø±Ø´Ø¯</label>
        <label><input name="education" type="radio" value="Ø¯Ú©ØªØ±Ø§">Ø¯Ú©ØªØ±Ø§</label>
      </div>
      <div>
        <span>Ø¬Ù†Ø³ÛŒØª:</span>
        <label><input name="gender" type="radio" value="Ø¢Ù‚Ø§" required>Ø¢Ù‚Ø§</label>
        <label><input name="gender" type="radio" value="Ø®Ø§Ù†Ù…">Ø®Ø§Ù†Ù…</label>
      </div>
      <div class="product-code-options">
        <span>Ú©Ø¯ Ù…Ø­ØµÙˆÙ„:</span>
        <label><input name="productCode" type="radio" value="A" required>A</label>
        <label><input name="productCode" type="radio" value="B">B</label>
        <label><input name="productCode" type="radio" value="C">C</label>
        <label><input name="productCode" type="radio" value="D">D</label>
        <label><input name="productCode" type="radio" value="E">E</label>
        <label><input name="productCode" type="radio" value="F">F</label>
        <label><input name="productCode" type="radio" value="G">G</label>
        <label><input name="productCode" type="radio" value="manual">Ø³Ø§ÛŒØ±</label>
        <input id="manualProductCode" name="manualProductCode"
               type="text" placeholder="ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ø¯ Ù…Ø­ØµÙˆÙ„" disabled>
      </div>
      <div>
        <label for="productName">Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„:</label>
        <input id="productName" name="productName" type="text"
               placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§</legend>
      <div class="param-row">
        <!-- ØªØ±ØªÛŒØ¨ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡: Ø±Ù†Ú¯ - Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ - Ø¨Ø§ÙØª - Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡ - Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ -->
        <div class="param-box">
          <label>Ø±Ù†Ú¯:</label>
          <div class="options">
            <label><input name="color" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="color" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="color" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="color" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="color" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
            <label><input name="color" type="radio" value="0">Ù†Ø¸Ø±ÛŒ Ù†Ø¯Ø§Ø±Ù…</label>
          </div>
        </div>

        <div class="param-box">
          <label>Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ:</label>
          <div class="options">
            <label><input name="smell" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="smell" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="smell" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="smell" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="smell" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
            <label><input name="smell" type="radio" value="0">Ù†Ø¸Ø±ÛŒ Ù†Ø¯Ø§Ø±Ù…</label>
          </div>
        </div>

        <div class="param-box">
          <label>Ø¨Ø§ÙØª:</label>
          <div class="options">
            <label><input name="texture" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="texture" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="texture" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="texture" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="texture" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
            <label><input name="texture" type="radio" value="0">Ù†Ø¸Ø±ÛŒ Ù†Ø¯Ø§Ø±Ù…</label>
          </div>
        </div>

        <div class="param-box">
          <label>Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡:</label>
          <div class="options">
            <label><input name="taste" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="taste" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="taste" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="taste" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="taste" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
            <label><input name="taste" type="radio" value="0">Ù†Ø¸Ø±ÛŒ Ù†Ø¯Ø§Ø±Ù…</label>
          </div>
        </div>

        <div class="param-box">
          <label>Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ:</label>
          <div class="options">
            <label><input name="mouthfeel" type="radio" value="5" required>Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</label>
            <label><input name="mouthfeel" type="radio" value="4">Ø®ÙˆØ¨</label>
            <label><input name="mouthfeel" type="radio" value="3">Ù…ØªÙˆØ³Ø·</label>
            <label><input name="mouthfeel" type="radio" value="2">Ø¶Ø¹ÛŒÙ</label>
            <label><input name="mouthfeel" type="radio" value="1">Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ</label>
            <label><input name="mouthfeel" type="radio" value="0">Ù†Ø¸Ø±ÛŒ Ù†Ø¯Ø§Ø±Ù…</label>
          </div>
        </div>
      </div>
      <div class="buttons">
        <button type="submit">Ø«Ø¨Øª</button>
        <button id="resetBtn" type="button">Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„</button>
        <button type="button" onclick="window.print()">Ú†Ø§Ù¾</button>
      </div>
    </fieldset>
  </form>

  <div id="tableProductName"></div>

  <h3>Ø¬Ø¯ÙˆÙ„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</h3>
  <table id="data-table">
    <thead>
      <tr>
        <th>Ú©Ø¯ Ù…Ø­ØµÙˆÙ„</th><th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th><th>ØªØ­ØµÛŒÙ„Ø§Øª</th>
        <th>Ø¬Ù†Ø³ÛŒØª</th>
        <!-- ØªØ±ØªÛŒØ¨ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ± Ù…Ø·Ø§Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡ -->
        <th>Ø±Ù†Ú¯</th><th>Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ</th><th>Ø¨Ø§ÙØª</th><th>Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡</th><th>Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="export-btns">
    <button class="csv"   onclick="exportCSV()">Export CSV</button>
    <button class="excel" onclick="exportExcel()">Export Excel</button>
    <button class="delete"onclick="clearAll()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
    <button class="html"  onclick="exportHTML()">Ø°Ø®ÛŒØ±Ù‡ HTML</button>
  </div>

  <h3>ØªØ­Ù„ÛŒÙ„ Ù…Ù‚Ø§ÛŒØ³Ù‡â€ŒØ§ÛŒ</h3>
  <div id="analysis"></div>
  <div id="resultBox" class="result-box"></div>

  <h3>Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</h3>
  <div class="charts-row">
    <!-- ØªØ±ØªÛŒØ¨ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ù†ÛŒØ² Ù…Ø·Ø§Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡: Ø±Ù†Ú¯ - Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ - Ø¨Ø§ÙØª - Ø·Ø¹Ù… - Ø§Ø­Ø³Ø§Ø³ -->
    <div class="chart-container">
      <canvas id="colorChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±Ù†Ú¯</p>
    </div>
    <div class="chart-container">
      <canvas id="smellChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ</p>
    </div>
    <div class="chart-container">
      <canvas id="textureChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¨Ø§ÙØª</p>
    </div>
    <div class="chart-container">
      <canvas id="tasteChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡</p>
    </div>
    <div class="chart-container">
      <canvas id="mouthfeelChart"></canvas>
      <p class="chart-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ</p>
    </div>
  </div>

  <div class="float-buttons">
    <button id="helpBtn"    type="button">ğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§</button>
    <button id="contactBtn" type="button">â„¹ï¸ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</button>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    let evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
    let editingIndex = -1, charts = {};

    document.addEventListener('DOMContentLoaded', () => {
      setJalaliDate();
      bindManualToggle();
      loadTable();
      updateAnalysisAndCharts();

      document.getElementById('resetBtn').onclick = () => {
        resetForm();
        window.scrollTo(0, 0);
      };
      document.getElementById('helpBtn').onclick = () => {
        alert(`Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ:\n1. Ù…Ø´Ø®ØµØ§Øª ÙØ±Ø¯ÛŒ\n2. Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ (ÛŒØ§ Ù†Ø¸Ø±ÛŒ Ù†Ø¯Ø§Ø±Ù…)\n3. Ø«Ø¨Øª Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ\n4. Ø±ÛŒØ³Øª ÙØ±Ù…\n5. Ú†Ø§Ù¾`);
      };
      document.getElementById('contactBtn').onclick = () => {
        alert(`Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡:\nÙ†Ø§Ù…: Mosayeb khani\nØªØ®ØµØµ: Ù…Ù‡Ù†Ø¯Ø³ÛŒ ØµÙ†Ø§ÛŒØ¹ ØºØ°Ø§ÛŒÛŒ\nØ§ÛŒÙ…ÛŒÙ„: mosayeb872@gmail.com`);
      };

      document.getElementById('evaluation-form').onsubmit = e => {
        e.preventDefault();
        const f = e.target;
        const code = f.productCode.value === 'manual'
                   ? f.manualProductCode.value.trim()
                   : f.productCode.value;
        const data = {
          productCode: code,
          productName: f.productName.value,
          education: f.education.value,
          gender: f.gender.value,
          // ØªØ±ØªÛŒØ¨ Ø¯Ø§Ø®Ù„ÛŒ Ø¯Ø± Ø¢Ø¨Ø¬Ú©Øª Ø§Ù‡Ù…ÛŒØªÛŒ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ù…:
          color:     +f.color.value,
          smell:     +f.smell.value,
          texture:   +f.texture.value,
          taste:     +f.taste.value,
          mouthfeel: +f.mouthfeel.value
        };
        if (editingIndex > -1) evaluations[editingIndex] = data;
        else evaluations.push(data);
        localStorage.setItem('evaluations', JSON.stringify(evaluations));
        localStorage.setItem('currentProductName', data.productName);

        // ğŸ‘‡ ØªØºÛŒÛŒØ±: Ø¨Ù‡â€ŒØ¬Ø§ÛŒ resetForm() ÙÙ‚Ø· Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        // (Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ØŒ Ú©Ø¯ Ù…Ø­ØµÙˆÙ„ØŒ Ø¬Ù†Ø³ÛŒØª Ùˆ ØªØ­ØµÛŒÙ„Ø§Øª Ø¯Ø³Øªâ€ŒÙ†Ø®ÙˆØ±Ø¯Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯)
        ['color','smell','texture','taste','mouthfeel'].forEach(name=>{
          document.querySelectorAll(`input[name="${name}"]`).forEach(r=> r.checked = false);
        });
        editingIndex = -1; // Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´
        loadTable();
        updateAnalysisAndCharts();
      };
    });

    function bindManualToggle() {
      document.querySelectorAll('input[name="productCode"]').forEach(r => {
        r.onchange = e => {
          const manual = document.getElementById('manualProductCode');
          if (e.target.value === 'manual') {
            manual.disabled = false;
            manual.required = true;
            manual.focus();
          } else {
            manual.disabled = true;
            manual.required = false;
            manual.value = '';
          }
        };
      });
    }

    function setJalaliDate() {
      const j = jalaali.toJalaali(new Date());
      document.getElementById('jalali-date').innerText =
        `ØªØ§Ø±ÛŒØ®: ${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
    }

    function resetForm() {
      // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù‡Ù…Ø§Ù† Ø±ÙØªØ§Ø± Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ø¯ (Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„)
      document.getElementById('evaluation-form').reset();
      editingIndex = -1;
      const m = document.getElementById('manualProductCode');
      m.disabled = true; m.required = false; m.value = '';
    }

    function loadTable() {
      const nameDiv = document.getElementById('tableProductName');
      const prod = localStorage.getItem('currentProductName') || '';
      nameDiv.innerText = prod ? `Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„: ${prod}` : '';
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      evaluations.forEach((d,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.productCode}</td>
          <td>${d.productName}</td>
          <td>${d.education}</td>
          <td>${d.gender}</td>
          <td>${d.color>0?d.color:'â€“'}</td>
          <td>${d.smell>0?d.smell:'â€“'}</td>
          <td>${d.texture>0?d.texture:'â€“'}</td>
          <td>${d.taste>0?d.taste:'â€“'}</td>
          <td>${d.mouthfeel>0?d.mouthfeel:'â€“'}</td>
          <td>
            <button class="action-btn" onclick="editRow(${i})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button class="action-btn delete" onclick="deleteRow(${i})">Ø­Ø°Ù</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function editRow(i) {
      const d = evaluations[i], f = document.getElementById('evaluation-form');
      const m = document.getElementById('manualProductCode');
      if (!['A','B','C','D','E','F','G'].includes(d.productCode)) {
        f.productCode.value = 'manual'; m.disabled = false; m.required = true; m.value = d.productCode;
      } else {
        f.productCode.value = d.productCode; m.disabled = true; m.required = false; m.value = '';
      }
      f.productName.value = d.productName;
      f.education.value   = d.education;
      f.gender.value      = d.gender;
      // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ù…Ø·Ø§Ø¨Ù‚ ØªØ±ØªÛŒØ¨ Ø¬Ø¯ÛŒØ¯
      f.color.value       = d.color;
      f.smell.value       = d.smell;
      f.texture.value     = d.texture;
      f.taste.value       = d.taste;
      f.mouthfeel.value   = d.mouthfeel;
      editingIndex = i; window.scrollTo(0,0);
    }

    function deleteRow(i) {
      if (!confirm('Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      evaluations.splice(i,1);
      localStorage.setItem('evaluations', JSON.stringify(evaluations));
      loadTable(); updateAnalysisAndCharts();
    }
    function clearAll() {
      if (!confirm('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      localStorage.removeItem('evaluations');
      evaluations = [];
      loadTable(); updateAnalysisAndCharts();
    }

    function updateAnalysisAndCharts() {
      const analysisDiv = document.getElementById('analysis'),
            resultBox   = document.getElementById('resultBox');
      if (!evaluations.length) {
        analysisDiv.innerText = 'Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.'; resultBox.innerText = '';
        Object.values(charts).forEach(c=>c.clear&&c.clear());
        return;
      }

      const codes = Array.from(new Set(evaluations.map(d=>d.productCode))),
            groups = {}, avg = {};
      codes.forEach(c=>groups[c]=[]);
      evaluations.forEach(d=>groups[d.productCode].push(d));

      // ğŸ‘‡ ØªÙˆØ¬Ù‡: ØªØ±ØªÛŒØ¨ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯
      const props = ['color','smell','texture','taste','mouthfeel'];

      codes.forEach(code=>{
        const arr = groups[code];
        props.forEach(prop=>{
          const vals = arr.map(x=>x[prop]).filter(v=>v>0);
          const sum  = vals.reduce((s,v)=>s+v,0);
          avg[code] = avg[code]||{};
          avg[code][prop] = vals.length? sum/vals.length : 0;
        });
      });

      const bestPerProp = {};
      props.forEach(prop=>{
        const maxVal = Math.max(...codes.map(c=>avg[c][prop]));
        bestPerProp[prop] = codes.filter(c=>avg[c][prop]===maxVal && maxVal>0);
      });

      const titles = {
        color:'Ø±Ù†Ú¯',
        smell:'Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ',
        texture:'Ø¨Ø§ÙØª',
        taste:'Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡',
        mouthfeel:'Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ'
      };

      const lines = Object.keys(titles).map(prop=>{
        const bests = bestPerProp[prop].length? bestPerProp[prop].join('ØŒ '):'â€“';
        const nums = bestPerProp[prop].length? bestPerProp[prop]
          .map(c=>avg[c][prop].toFixed(2)).join('ØŒ '):'';
        return `Ø¨Ø®Ø´ ${titles[prop]}: ${bests}${nums?` (${nums})`:''}`;
      });
      analysisDiv.innerHTML = lines.map(l=>`â€¢ ${l}`).join('<br>');
      resultBox.innerText = '';

      // ÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø·Ù„ÙˆØ¨
      analysisDiv.insertAdjacentHTML('beforeend', `
        <div class="best-selection">
          <span>Ù„Ø·ÙØ§Ù‹ Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø·Ù„ÙˆØ¨ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</span>
          ${codes.map(c=>`<label><input type="radio" name="userBest" value="${c}">${c}</label>`).join('')}
          <button id="selectBestBtn">Ø«Ø¨Øª Ø§Ù†ØªØ®Ø§Ø¨</button>
        </div>
      `);
      document.getElementById('selectBestBtn').onclick = ()=>{
        const sel = document.querySelector('input[name="userBest"]:checked');
        if (!sel) { alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù†Ù…ÙˆÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); return; }
        resultBox.innerText = ` Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø¯ ${sel.value} Ø§Ø² Ù†Ø¸Ø± Ú©Ù„ÛŒ Ù…Ø·Ù„ÙˆØ¨ ØªØ± Ø§Ø² Ø³Ø§ÛŒØ± Ù†Ù…ÙˆÙ†Ù‡ Ù‡Ø§ÛŒ Ù…ÛŒ Ø¨Ø§Ø´Ø¯.`;
      };

      // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø·Ø§Ø¨Ù‚ ØªØ±ØªÛŒØ¨ Ø®ÙˆØ§Ø³ØªÙ‡
      const dataSets = props.map(prop=>codes.map(c=>avg[c][prop].toFixed(2)));
      const palette = [
        'rgba(255,99,132,0.7)','rgba(54,162,235,0.7)','rgba(255,206,86,0.7)',
        'rgba(75,192,192,0.7)','rgba(153,102,255,0.7)','rgba(255,159,64,0.7)',
        'rgba(99,255,132,0.7)'
      ];
      const colors = {}; codes.forEach((c,i)=>colors[c]=palette[i%palette.length]);

      const makeCfg = (label,data)=>({
        type:'bar',
        data:{ labels:codes, datasets:[{ label, data, backgroundColor:codes.map(k=>colors[k]) }]},
        options:{
          indexAxis:'y', responsive:true, maintainAspectRatio:false,
          scales:{ x:{ min:0, max:5 } },
          plugins:{ datalabels:{ color:'#000', anchor:'end', align:'right', formatter:v=>v } }
        }
      });

      // Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø·Ø§Ø¨Ù‚ ØªØ±ØªÛŒØ¨: color, smell, texture, taste, mouthfeel
      const ids=['colorChart','smellChart','textureChart','tasteChart','mouthfeelChart'];
      ids.forEach((id,i)=>{
        if (!charts[id]) {
          charts[id] = new Chart(document.getElementById(id), makeCfg(
            document.querySelector(`#${id}+ .chart-label`).innerText,
            dataSets[i]
          ));
        } else {
          charts[id].data.labels = codes;
          charts[id].data.datasets[0].data = dataSets[i];
          charts[id].data.datasets[0].backgroundColor = codes.map(k=>colors[k]);
          charts[id].update();
        }
      });
    }

    function exportCSV() {
      if (!evaluations.length) { alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.'); return; }
      // ØªØ±ØªÛŒØ¨ header Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø¯ÙˆÙ„: Ú©Ø¯ØŒ Ù†Ø§Ù…ØŒ ØªØ­ØµÛŒÙ„Ø§ØªØŒ Ø¬Ù†Ø³ÛŒØªØŒ Ø±Ù†Ú¯ØŒ Ø¹Ø·Ø± Ùˆ Ø¨ÙˆØŒ Ø¨Ø§ÙØªØŒ Ø·Ø¹Ù…ØŒ Ø§Ø­Ø³Ø§Ø³
      const header=['Ú©Ø¯','Ù†Ø§Ù…','ØªØ­ØµÛŒÙ„Ø§Øª','Ø¬Ù†Ø³ÛŒØª','Ø±Ù†Ú¯','Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ','Ø¨Ø§ÙØª','Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡','Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ'];
      const rows=evaluations.map(d=>[
        d.productCode,d.productName,d.education,d.gender,
        d.color>0?d.color:'',d.smell>0?d.smell:'',d.texture>0?d.texture:'',d.taste>0?d.taste:'',d.mouthfeel>0?d.mouthfeel:''
      ]);
      let csv='\uFEFF'+header.join(',')+'\n'+rows.map(r=>r.join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download='evaluations.csv';
      link.click();
    }

    function exportExcel() {
      if (!evaluations.length) { alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.'); return; }
      const header=['Ú©Ø¯ Ù…Ø­ØµÙˆÙ„','Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„','ØªØ­ØµÛŒÙ„Ø§Øª','Ø¬Ù†Ø³ÛŒØª','Ø±Ù†Ú¯','Ø¹Ø·Ø± Ùˆ Ø¨Ùˆ','Ø¨Ø§ÙØª','Ø·Ø¹Ù… Ùˆ Ù…Ø²Ù‡','Ø§Ø­Ø³Ø§Ø³ Ø¯Ù‡Ø§Ù†ÛŒ'];
      const rows=evaluations.map(d=>[
        d.productCode,d.productName,d.education,d.gender,
        d.color>0?d.color:'',d.smell>0?d.smell:'',d.texture>0?d.texture:'',d.taste>0?d.taste:'',d.mouthfeel>0?d.mouthfeel:''
      ]);
      let html='<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body><table><tr>';
      header.forEach(h=>html+=`<th>${h}</th>`); html+='</tr>';
      rows.forEach(r=>{ html+='<tr>'; r.forEach(c=>html+=`<td>${c}</td>`); html+='</tr>'; });
      html+='</table></body></html>';
      const blob=new Blob(['\uFEFF',html],{type:'application/vnd.ms-excel'});
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download='evaluations.xls';
      link.click();
    }

    function exportHTML() {
      const prodRaw=localStorage.getItem('currentProductName')||'Ø¨Ø¯ÙˆÙ†_Ù†Ø§Ù…';
      const j=jalaali.toJalaali(new Date());
      const dateStr=`${j.jy}${String(j.jm).padStart(2,'0')}${String(j.jd).padStart(2,'0')}`;
      const prodClean=prodRaw.replace(/\s+/g,'_').replace(/[^Ø¢-ÛŒA-Za-z0-9_\-]/g,'');
      const filename=`Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ-${prodClean}-${dateStr}.html`;

      let smallHtml=`<!DOCTYPE html><html lang="fa" dir="rtl"><head><meta charset="UTF-8">
<title>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ${prodRaw} - ${dateStr}</title>
<style>body{font-family:Tahoma,sans-serif;padding:1rem;direction:rtl;text-align:right;}
table{width:100%;border-collapse:collapse;margin-bottom:1rem;}
th,td{border:1px solid #ccc;padding:.6rem;text-align:center;}
img{max-width:100%;height:auto;margin-bottom:1rem;display:block;}
.result-box{border:2px solid #4caf50;background:#e8f5e9;padding:1rem;margin-bottom:1rem;border-radius:6px;color:#2e7d32;font-weight:bold;}
</style></head><body>
<h3>Ø¬Ø¯ÙˆÙ„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</h3>${document.getElementById('data-table').outerHTML}
<h3>ØªØ­Ù„ÛŒÙ„ Ù…Ù‚Ø§ÛŒØ³Ù‡â€ŒØ§ÛŒ</h3>${document.getElementById('analysis').innerHTML}
<div class="result-box">${document.getElementById('resultBox').innerHTML}</div>
<h3>Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</h3>`;

      ['colorChart','smellChart','textureChart','tasteChart','mouthfeelChart']
      .forEach(id=>{
        const c=document.getElementById(id),
              label=c.nextElementSibling.innerText;
        smallHtml+=`<h4>${label}</h4><img src="${c.toDataURL('image/png')}" alt="${label}"/>`;
      });
      smallHtml+='</body></html>';

      const blob=new Blob([smallHtml],{type:'text/html;charset=utf-8'});
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download=filename;
      link.click();
    }
  </script>
</body>
</html>

