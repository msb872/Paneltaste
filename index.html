<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>فرم ارزیابی تست پنل</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      margin: 20px auto;
      max-width: 1200px;
      direction: rtl;
      text-align: right;
      color: #333;
    }

    form {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 6px;
      background: #fafafa;
    }
    fieldset {
      border: 1px solid #bbb;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }
    legend { font-weight: bold; }
    label { margin-left: .5rem; cursor: pointer; }

    .product-code-options {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .product-code-options input[type="text"] {
      width: 120px;
      padding: .4rem;
      border: 1px solid #bbb;
      border-radius: 4px;
    }

    .param-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .param-box {
      flex: 1 1 200px;
      border: 1px solid #ddd;
      padding: .8rem;
      border-radius: 4px;
      background: #fff;
    }
    /* راست‌چین و row-reverse برای گزینه‌ها */
    .param-box .options {
      display: flex;
      flex-wrap: wrap;
      gap: .8rem;
      margin-top: .5rem;
      direction: rtl;
    }
    .param-box .options label {
      display: inline-flex;
      flex-direction: row-reverse;
      align-items: center;
      gap: .3rem;
    }

    .buttons, .export-btns {
      margin-top: 1rem;
    }
    .buttons button,
    .export-btns button {
      margin-left: .5rem;
      padding: .6rem 1.2rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    .buttons button { background: #1976d2; }
    .buttons button:hover { background: #0f5caa; }
    .export-btns button.csv    { background: #388e3c; }
    .export-btns button.excel  { background: #1e88e5; }
    .export-btns button.delete { background: #d32f2f; }
    .export-btns button.html   { background: #6a1b9a; }
    .export-btns button.html:hover { background: #4a148c; }

    #tableProductName {
      font-weight: bold;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: .6rem;
      text-align: center;
    }
    .action-btn {
      background: #f57c00;
      margin: 0 .2rem;
      padding: .2rem .6rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    .action-btn.delete { background: #d32f2f; }

    .charts-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
    }
    .chart-container {
      flex: 1 1 200px;
      height: 200px;
      position: relative;
    }
    .chart-label {
      text-align: center;
      margin-top: .3rem;
      font-size: .95rem;
    }

    /* انتخاب نمونه مطلوب */
    .best-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      direction: rtl;
      margin-top: 1rem;
      align-items: center;
    }
    .best-selection label {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
    }
    .best-selection button {
      padding: .4rem .8rem;
      border: none;
      border-radius: 4px;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
    }
    .best-selection button:hover {
      background: #0f5caa;
    }

    .float-buttons {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      z-index: 1000;
    }
    .float-buttons button {
      padding: .6rem 1rem;
      border: none;
      border-radius: 4px;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }
    .float-buttons button:hover {
      background: #0f5caa;
    }

    .result-box {
      border: 2px solid #4caf50;
      background: #e8f5e9;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
      font-size: 1.1rem;
      color: #2e7d32;
    }

    @media print {
      form, .buttons, .export-btns, .float-buttons { display: none !important; }
      #tableProductName, h3, #analysis, #resultBox, table { page-break-inside: avoid; }
      .charts-row {
        display: block;
        column-count: 2;
        column-gap: 1rem;
      }
      .chart-container {
        break-inside: avoid-column;
        page-break-inside: avoid;
        margin-bottom: 1rem;
      }
      .chart-label, canvas {
        display: block !important;
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>

  <h2 id="jalali-date" aria-label="تاریخ شمسی"></h2>

  <form id="evaluation-form" aria-label="فرم ارزیابی تست پنل">
    <fieldset>
      <legend>مشخصات فردی</legend>
      <div>
        <span>تحصیلات:</span>
        <label><input name="education" type="radio" value="دیپلم" required>دیپلم</label>
        <label><input name="education" type="radio" value="کاردانی">کاردانی</label>
        <label><input name="education" type="radio" value="کارشناسی">کارشناسی</label>
        <label><input name="education" type="radio" value="ارشد">ارشد</label>
        <label><input name="education" type="radio" value="دکترا">دکترا</label>
      </div>
      <div style="margin-top:1rem;">
        <span>جنسیت:</span>
        <label><input name="gender" type="radio" value="آقا" required>آقا</label>
        <label><input name="gender" type="radio" value="خانم">خانم</label>
      </div>
      <div class="product-code-options">
        <span>کد محصول:</span>
        <label><input name="productCode" type="radio" value="A" required>A</label>
        <label><input name="productCode" type="radio" value="B">B</label>
        <label><input name="productCode" type="radio" value="C">C</label>
        <label><input name="productCode" type="radio" value="D">D</label>
        <label><input name="productCode" type="radio" value="E">E</label>
        <label><input name="productCode" type="radio" value="F">F</label>
        <label><input name="productCode" type="radio" value="G">G</label>
        <label><input name="productCode" type="radio" value="manual">سایر</label>
        <input id="manualProductCode" name="manualProductCode"
               type="text" placeholder="وارد کردن کد محصول" disabled>
      </div>
      <div style="margin-top:1rem;">
        <label for="productName">نام محصول:</label>
        <input id="productName" name="productName" type="text"
               placeholder="نام محصول را وارد کنید" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>ارزیابی پارامترها</legend>

      <!-- رنگ -->
      <div class="param-box">
        <label>رنگ:</label>
        <div class="options">
          <label><input name="color" type="radio" value="5" required>خیلی خوب</label>
          <label><input name="color" type="radio" value="4">خوب</label>
          <label><input name="color" type="radio" value="3">متوسط</label>
          <label><input name="color" type="radio" value="2">ضعیف</label>
          <label><input name="color" type="radio" value="1">خیلی ضعیف</label>
          <label><input name="color" type="radio" value="0">نظری ندارم</label>
        </div>
      </div>

      <!-- طعم و مزه -->
      <div class="param-box">
        <label>طعم و مزه:</label>
        <div class="options">
          <label><input name="taste" type="radio" value="5" required>خیلی خوب</label>
          <label><input name="taste" type="radio" value="4">خوب</label>
          <label><input name="taste" type="radio" value="3">متوسط</label>
          <label><input name="taste" type="radio" value="2">ضعیف</label>
          <label><input name="taste" type="radio" value="1">خیلی ضعیف</label>
          <label><input name="taste" type="radio" value="0">نظری ندارم</label>
        </div>
      </div>

      <!-- عطر و بو -->
      <div class="param-box">
        <label>عطر و بو:</label>
        <div class="options">
          <label><input name="smell" type="radio" value="5" required>خیلی خوب</label>
          <label><input name="smell" type="radio" value="4">خوب</label>
          <label><input name="smell" type="radio" value="3">متوسط</label>
          <label><input name="smell" type="radio" value="2">ضعیف</label>
          <label><input name="smell" type="radio" value="1">خیلی ضعیف</label>
          <label><input name="smell" type="radio" value="0">نظری ندارم</label>
        </div>
      </div>

      <!-- بافت -->
      <div class="param-box">
        <label>بافت:</label>
        <div class="options">
          <label><input name="texture" type="radio" value="5" required>خیلی خوب</label>
          <label><input name="texture" type="radio" value="4">خوب</label>
          <label><input name="texture" type="radio" value="3">متوسط</label>
          <label><input name="texture" type="radio" value="2">ضعیف</label>
          <label><input name="texture" type="radio" value="1">خیلی ضعیف</label>
          <label><input name="texture" type="radio" value="0">نظری ندارم</label>
        </div>
      </div>

      <!-- احساس دهانی -->
      <div class="param-box">
        <label>احساس دهانی:</label>
        <div class="options">
          <label><input name="mouthfeel" type="radio" value="5" required>خیلی خوب</label>
          <label><input name="mouthfeel" type="radio" value="4">خوب</label>
          <label><input name="mouthfeel" type="radio" value="3">متوسط</label>
          <label><input name="mouthfeel" type="radio" value="2">ضعیف</label>
          <label><input name="mouthfeel" type="radio" value="1">خیلی ضعیف</label>
          <label><input name="mouthfeel" type="radio" value="0">نظری ندارم</label>
        </div>
      </div>

      <div class="buttons">
        <button type="submit">ثبت</button>
        <button id="resetBtn" type="button">ریست کامل</button>
        <button type="button" onclick="window.print()">چاپ</button>
      </div>
    </fieldset>
  </form>

  <div id="tableProductName"></div>

  <h3>جدول ارزیابی‌ها</h3>
  <table id="data-table">
    <thead>
      <tr>
        <th>کد محصول</th><th>نام محصول</th><th>تحصیلات</th>
        <th>جنسیت</th><th>رنگ</th><th>طعم و مزه</th>
        <th>عطر و بو</th><th>بافت</th><th>احساس دهانی</th><th>عملیات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="export-btns">
    <button class="csv"   onclick="exportCSV()">Export CSV</button>
    <button class="excel" onclick="exportExcel()">Export Excel</button>
    <button class="delete"onclick="clearAll()">پاک کردن همه</button>
    <button class="html"  onclick="exportHTML()">ذخیره HTML</button>
  </div>

  <h3>تحلیل مقایسه‌ای</h3>
  <div id="analysis"></div>
  <div id="resultBox" class="result-box"></div>

  <h3>نمودارها</h3>
  <div class="charts-row">
    <div class="chart-container">
      <canvas id="colorChart"></canvas>
      <p class="chart-label">میانگین رنگ</p>
    </div>
    <div class="chart-container">
      <canvas id="tasteChart"></canvas>
      <p class="chart-label">میانگین طعم و مزه</p>
    </div>
    <div class="chart-container">
      <canvas id="smellChart"></canvas>
      <p class="chart-label">میانگین عطر و بو</p>
    </div>
    <div class="chart-container">
      <canvas id="textureChart"></canvas>
      <p class="chart-label">میانگین بافت</p>
    </div>
    <div class="chart-container">
      <canvas id="mouthfeelChart"></canvas>
      <p class="chart-label">میانگین احساس دهانی</p>
    </div>
  </div>

  <div class="float-buttons">
    <button id="helpBtn"    type="button">📋 راهنما</button>
    <button id="contactBtn" type="button">ℹ️ درباره نویسنده</button>
  </div>

  <script>
    Chart.register(ChartDataLabels);

    let evaluations  = JSON.parse(localStorage.getItem('evaluations') || '[]');
    let editingIndex = -1;
    let charts       = {};

    document.addEventListener('DOMContentLoaded', () => {
      setJalaliDate();
      bindManualToggle();
      loadTable();
      updateAnalysisAndCharts();

      document.getElementById('resetBtn').addEventListener('click', () => {
        resetForm(); window.scrollTo(0,0);
      });

      document.getElementById('helpBtn').addEventListener('click', () => {
        alert(`راهنمای فرم ارزیابی:
1. مشخصات فردی: تحصیلات، جنسیت، کد محصول (A–G یا سایر) و نام محصول.
2. ارزیابی: رنگ، طعم، عطر، بافت و احساس دهانی (هرکدام 1–5 یا نظری ندارم).
3. ثبت: ذخیره و به‌روزرسانی.
4. ریست: پاک کردن فرم.
5. چاپ: نسخه چاپی با نمودارها دو ستونه.`);
      });

      document.getElementById('contactBtn').addEventListener('click', () => {
        alert(`درباره نویسنده:
نام: Mosayeb khani  
تخصص: مهندسی صنایع غذایی  
ایمیل: mosayeb872@gmail.com  
تماس:+989173206052`);
      });

      document.getElementById('evaluation-form').addEventListener('submit', e => {
        e.preventDefault();
        const f    = e.target;
        const code = f.productCode.value === 'manual'
                   ? f.manualProductCode.value.trim()
                   : f.productCode.value;
        const data = {
          productCode: code,
          productName: f.productName.value,
          education:   f.education.value,
          gender:      f.gender.value,
          color:       +f.color.value,
          taste:       +f.taste.value,
          smell:       +f.smell.value,
          texture:     +f.texture.value,
          mouthfeel:   +f.mouthfeel.value
        };

        if (editingIndex > -1) evaluations[editingIndex] = data;
        else               evaluations.push(data);

        localStorage.setItem('evaluations', JSON.stringify(evaluations));
        localStorage.setItem('currentProductName', data.productName);

        resetForm();
        loadTable();
        updateAnalysisAndCharts();
      });
    });

    function bindManualToggle() {
      document.querySelectorAll('input[name="productCode"]').forEach(radio => {
        radio.addEventListener('change', e => {
          const manual = document.getElementById('manualProductCode');
          if (e.target.value === 'manual') {
            manual.disabled = false;
            manual.required = true;
            manual.focus();
          } else {
            manual.disabled = true;
            manual.required = false;
            manual.value = '';
          }
        });
      });
    }

    function setJalaliDate() {
      const j = jalaali.toJalaali(new Date());
      document.getElementById('jalali-date').innerText =
        `تاریخ: ${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
    }

    function resetForm() {
      document.getElementById('evaluation-form').reset();
      editingIndex = -1;
      const manual = document.getElementById('manualProductCode');
      manual.disabled = true;
      manual.required = false;
      manual.value = '';
    }

    function loadTable() {
      const nameDiv = document.getElementById('tableProductName');
      const prod    = localStorage.getItem('currentProductName') || '';
      nameDiv.innerText = prod ? `نام محصول: ${prod}` : '';

      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      evaluations.forEach((d,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.productCode}</td>
          <td>${d.productName}</td>
          <td>${d.education}</td>
          <td>${d.gender}</td>
          <td>${d.color>0?d.color:'–'}</td>
          <td>${d.taste>0?d.taste:'–'}</td>
          <td>${d.smell>0?d.smell:'–'}</td>
          <td>${d.texture>0?d.texture:'–'}</td>
          <td>${d.mouthfeel>0?d.mouthfeel:'–'}</td>
          <td>
            <button class="action-btn" onclick="editRow(${i})">ویرایش</button>
            <button class="action-btn delete" onclick="deleteRow(${i})">حذف</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function updateAnalysisAndCharts() {
      const analysisDiv = document.getElementById('analysis');
      const resultBox   = document.getElementById('resultBox');

      if (!evaluations.length) {
        analysisDiv.innerText = 'داده‌ای موجود نیست.';
        resultBox.innerText = '';
        Object.values(charts).forEach(c => c.clear && c.clear());
        return;
      }

      const codes  = Array.from(new Set(evaluations.map(d => d.productCode)));
      const groups = {};
      codes.forEach(c => groups[c] = []);
      evaluations.forEach(d => groups[d.productCode].push(d));

      const avg = {};
      codes.forEach(code => {
        const arr = groups[code];
        ['color','taste','smell','texture','mouthfeel'].forEach(prop => {
          const vals = arr.map(x => x[prop]).filter(v => v > 0);
          const sum  = vals.reduce((s,v) => s+v, 0);
          avg[code] = avg[code] || {};
          avg[code][prop] = vals.length ? sum/vals.length : 0;
        });
      });

      // تعیین همه نمونه‌های برتر مساوی
      const bestPerProp = {};
      ['color','taste','smell','texture','mouthfeel'].forEach(prop => {
        const maxVal = Math.max(...codes.map(c => avg[c][prop]));
        bestPerProp[prop] = codes.filter(c => avg[c][prop] === maxVal && maxVal>0);
      });

      // ساخت متن تحلیل
      const lines = ['color','taste','smell','texture','mouthfeel'].map(prop => {
        const titles = {
          color: 'رنگ',
          taste: 'طعم و مزه',
          smell: 'عطر و بو',
          texture: 'بافت',
          mouthfeel: 'احساس دهانی'
        };
        const bests = bestPerProp[prop].length
          ? bestPerProp[prop].join('، ')
          : '–';
        const nums = bestPerProp[prop].length
          ? bestPerProp[prop].map(c => avg[c][prop].toFixed(2)).join('، ')
          : '';
        return `بخش ${titles[prop]}: ${bests}${nums?` (${nums})`:''}`;
      });

      analysisDiv.innerHTML = lines.map(l => `• ${l}`).join('<br>');
      resultBox.innerText = '';

      // فرم انتخاب نمونه مطلوب
      analysisDiv.insertAdjacentHTML('beforeend', `
        <div class="best-selection">
          <span>لطفاً نمونه مطلوب خود را انتخاب کنید:</span>
          ${codes.map(c => `<label><input type="radio" name="userBest" value="${c}">${c}</label>`).join('')}
          <button id="selectBestBtn" type="button">ثبت انتخاب</button>
        </div>
      `);
      document.getElementById('selectBestBtn').onclick = () => {
        const sel = document.querySelector('input[name="userBest"]:checked');
        if (!sel) { alert('لطفاً یک نمونه را انتخاب کنید.'); return; }
        resultBox.innerText = `نمونه کد ${sel.value}  از نظر ارزیاب مطلوب تر از سایر کدها می باشد.`;
      };

      // داده‌های نمودار
      const dataSets = ['color','taste','smell','texture','mouthfeel'].map(prop =>
        codes.map(c => avg[c][prop].toFixed(2))
      );
      const palette = [
        'rgba(255,99,132,0.7)','rgba(54,162,235,0.7)',
        'rgba(255,206,86,0.7)','rgba(75,192,192,0.7)',
        'rgba(153,102,255,0.7)','rgba(255,159,64,0.7)',
        'rgba(99,255,132,0.7)'
      ];
      const colors = {};
      codes.forEach((c,i) => colors[c] = palette[i % palette.length]);

      const makeCfg = (label,data) => ({
        type: 'bar',
        data: { labels: codes, datasets:[{ label,data, backgroundColor: codes.map(k=>colors[k]) }] },
        options: {
          indexAxis:'y', responsive:true, maintainAspectRatio:false,
          scales:{ x:{ min:0, max:5 } },
          plugins:{ datalabels:{ color:'#000', anchor:'end', align:'right', formatter:v=>v } }
        }
      });

      const chartIds = ['colorChart','tasteChart','smellChart','textureChart','mouthfeelChart'];
      chartIds.forEach((id,i) => {
        if (!charts[id]) {
          charts[id] = new Chart(document.getElementById(id), makeCfg(
            document.querySelector(`#${id} + .chart-label`).innerText,
            dataSets[i]
          ));
        } else {
          charts[id].data.labels = codes;
          charts[id].data.datasets[0].data = dataSets[i];
          charts[id].data.datasets[0].backgroundColor = codes.map(k=>colors[k]);
          charts[id].update();
        }
      });
    }

    function deleteRow(i) {
      if (!confirm('مطمئنید حذف شود؟')) return;
      evaluations.splice(i,1);
      localStorage.setItem('evaluations', JSON.stringify(evaluations));
      loadTable(); updateAnalysisAndCharts();
    }
    function clearAll() {
      if (!confirm('همه داده‌ها حذف شود؟')) return;
      localStorage.removeItem('evaluations');
      evaluations=[]; loadTable(); updateAnalysisAndCharts();
    }

    function exportCSV() {
      if (!evaluations.length) { alert('داده‌ای وجود ندارد.'); return; }
      const header = ['کد','نام','تحصیلات','جنسیت','رنگ','طعم','عطر','بافت','احساس'];
      const rows = evaluations.map(d => [
        d.productCode,d.productName,d.education,d.gender,
        d.color>0?d.color:'',d.taste>0?d.taste:'',
        d.smell>0?d.smell:'',d.texture>0?d.texture:'',d.mouthfeel>0?d.mouthfeel:''
      ]);
      let csv = '\uFEFF'+header.join(',')+'\n'+rows.map(r=>r.join(',')).join('\n');
      const blob=new Blob([csv],{ type:'text/csv;charset=utf-8;' });
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download='evaluations.csv';
      link.click();
    }

    function exportExcel() {
      if (!evaluations.length) { alert('داده‌ای وجود ندارد.'); return; }
      const header = ['کد محصول','نام محصول','تحصیلات','جنسیت','رنگ','طعم','عطر','بافت','احساس دهانی'];
      const rows = evaluations.map(d => [
        d.productCode,d.productName,d.education,d.gender,
        d.color>0?d.color:'',d.taste>0?d.taste:'',
        d.smell>0?d.smell:'',d.texture>0?d.texture:'',d.mouthfeel>0?d.mouthfeel:''
      ]);
      let html = '<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body><table><tr>';
      header.forEach(h=>html+=`<th>${h}</th>`); html+='</tr>';
      rows.forEach(r=>{ html+='<tr>'; r.forEach(c=>html+=`<td>${c}</td>`); html+='</tr>'; });
      html+='</table></body></html>';
      const blob=new Blob(['\uFEFF',html],{ type:'application/vnd.ms-excel' });
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download='evaluations.xls';
      link.click();
    }

    function exportHTML() {
      const prodRaw=localStorage.getItem('currentProductName')||'بدون_نام';
      const j=jalaali.toJalaali(new Date());
      const dateStr=`${j.jy}${String(j.jm).padStart(2,'0')}${String(j.jd).padStart(2,'0')}`;
      const prodClean=prodRaw.replace(/\s+/g,'_').replace(/[^آ-یA-Za-z0-9_\-]/g,'');
      const filename=`ارزیابی-${prodClean}-${dateStr}.html`;

      let smallHtml=`<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head><meta charset="UTF-8"><title>ارزیابی ${prodRaw} - ${dateStr}</title>
<style>body{font-family:Tahoma,sans-serif;padding:1rem;direction:rtl;text-align:right;}
table{width:100%;border-collapse:collapse;margin-bottom:1rem;}
th,td{border:1px solid #ccc;padding:.6rem;text-align:center;}
img{max-width:100%;height:auto;margin-bottom:1rem;display:block;}
.result-box{border:2px solid #4caf50;background:#e8f5e9;padding:1rem;margin-bottom:1rem;border-radius:6px;color:#2e7d32;font-weight:bold;}
</style></head><body>
<h3>جدول ارزیابی‌ها</h3>${document.getElementById('data-table').outerHTML}
<h3>تحلیل مقایسه‌ای</h3>${document.getElementById('analysis').innerHTML}
<div class="result-box">${document.getElementById('resultBox').innerHTML}</div>
<h3>نمودارها</h3>`;

      ['colorChart','tasteChart','smellChart','textureChart','mouthfeelChart']
      .forEach(id=>{
        const canvas=document.getElementById(id);
        const label=canvas.nextElementSibling.innerText;
        smallHtml+=`<h4>${label}</h4><img src="${canvas.toDataURL('image/png')}" alt="${label}"/>`;
      });
      smallHtml+='</body></html>';

      const blob=new Blob([smallHtml],{ type:'text/html;charset=utf-8' });
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download=filename;
      link.click();
    }
  </script>
</body>
</html>
```
